rule process_spawn_in_setup {
    meta:
        confidence = "high"
        classification = "threat"

    strings:
        // NOTE(ww): We don't detect `import os as ...`
        $from_os_import = /from os import /

        // Bare calls to suspicious os methods.
        $bare_system = "system"
        $bare_exec = /exec.*/
        $bare_spawn = /spawn.*/
        $bare_posix_spawn = /posix_spawn.*/
        $bare_popen = /popen.*/

        // Fully qualified calls to suspicious os methods.
        $fq_system = "os.system("
        $fq_exec = /os\.exec.*/
        $fq_spawn = /os\.spawn.*/
        $fq_posix_spawn = /os\.posix_spawn.*/
        $fq_popen = /os\.popen.*/

    condition:
        (1 of ($fq_*)) or ($from_os_import and (1 of ($bare_*)))
}

rule subprocess_in_setup {
    meta:
        confidence = "high"
        classification = "threat"

    strings:
        // NOTE(ww): We don't detect `import subprocess as ...`
        $from_subprocess_import = /from subprocess import /

        // Bare calls to suspicious subprocess methods/objects
        $bare_run = "run"
        $bare_Popen = "Popen"
        $bare_call = "call"
        $bare_check_call = "check_call"
        $bare_check_output = "check_output"

        // Fully qualified calls to suspicious subprocess methods/objects
        $fq_run = "subprocess.run"
        $fq_Popen = "subprocess.Popen"
        $fq_call = "subprocess.call"
        $fq_check_call = "subprocess.check_call"
        $fq_check_output = "subprocess.check_output"

    condition:
        (1 of ($fq_*) or ($from_subprocess_import and (1 of ($bare_*))))
}

rule networking_in_setup {
    meta:
        confidence = "medium"
        classification = "threat"

    strings:
        // Other candidates: poplib, imaplib, nntplib, smtplib, telnetlib
        $from_socket_import = /from socket(\..+)? import/
        $from_socketserver_import = /from socketserver(\..+)? import/
        $from_ssl_import = /from ssl(\..+)? import/
        $from_ftplib_import = /from ftplib(\..+)? import/
        $from_http_import = /from http(\..+)? import/
        $from_urllib_import = /from urllib(\..+)? import/
        $from_xmlrpc_sub_import = /from xmlrpc(\..+)? import/

        $import_socket = /import socket(\..+)?/
        $import_socketserver = /import socketserver(\..+)?/
        $import_ssl = /import ssl(\..+)?/
        $import_ftplib = /import ftplib(\..+)?/
        $import_http = /import http(\..+)?/
        $import_http_sub = /import http(\..+)?/
        $import_urllib = /import urllib(\..+)?/
        $import_urllib_sub = /import urllib(\..+)?/
        $import_xmlrpc = /import xmlrpc(\..+)?/
        $import_xmlrpc_sub = /import xmlrpc(\..+)?/

    condition:
        any of them
}

// rule deserialization_in_setup {
//     meta:
//         confidence = "medium"
// }
