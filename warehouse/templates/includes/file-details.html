{#
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-#}

{% macro publisher(publ) -%}
{% if publ.kind == "GitHub" %}
<p>
  Publisher: <a href="https://github.com/{{ publ.repository }}/blob/HEAD/.github/workflows/{{ publ.workflow }}">
    <i class="fa-brands fa-github" aria-hidden="true"></i>
    <code>{{ publ.workflow }}</code> on {{ publ.repository }}
  </a>
</p>
{% elif publ.kind == "GitLab" %}
<p>
  Publisher: <a href="https://gitlab.com/{{ publ.repository }}/blob/HEAD/{{ publ.workflow_filepath }}">
    <i class="fa-brands fa-gitlab" aria-hidden="true"></i>
    <code>{{ publ.workflow_filepath }}</code> on {{ publ.repository }}
  </a>
</p>
{% endif %}
{%- endmacro %}

<div id="{{ file.filename }}" data-project-tabs-target="content" class="vertical-tabs__content" role="tabpanel" aria-labelledby="file-tab mobile-file-tab" tabindex="-1">
  <h2 class="page-title">{% trans %}File details{% endtrans %}</h2>
  <p>Details for the file <code>{{ file.filename }}</code>.</p>

  <h3>File metadata</h3>
  <div>
    <ul>
      <li>
        Download URL: <a href="{{ request.route_url('packaging.file', path=file.path) }}">
          {{ file.filename }}
        </a>
      </li>
      <li>{% trans upload_time=humanize(file.upload_time) %} Upload date: {{ upload_time }} {% endtrans %}</li>
      <li>{% trans size=file.size|filesizeformat() if file.size else 0|filesizeformat() %} Size: {{ size }} {% endtrans %}</li>
      <li>{% trans tags=', '.join(file.pretty_wheel_tags) %} Tags: {{ tags }} {% endtrans %}</li>
      <li>
        {% trans is_tp="Yes" if file.uploaded_via_trusted_publisher else "No" %}
        Uploaded using Trusted Publishing? {{ is_tp }}
        {% endtrans %}
      </li>
      {% if file.uploaded_via %}
      <li>{% trans uploaded_via=file.uploaded_via %} Uploaded via: {{ uploaded_via }} {% endtrans %}</li>
      {% endif %}
    </ul>
  </div>

  <h3>File hashes</h3>
  <div>
    <table class="table table--hashes">
      <caption class="sr-only">{% trans filename=file.filename %}Hashes for {{ filename }}{% endtrans %}</caption>
      <thead>
        <tr>
          <th scope="col">{% trans %}Algorithm{% endtrans %}</th>
          <th scope="col">{% trans %}Hash digest{% endtrans %}</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr data-controller="clipboard">
          <th scope="row">SHA256</th>
          <td><code data-clipboard-target="source">{{ file.sha256_digest }}</code></td>
          <td class="table__align-right">
            <button type="button" class="button button--small copy-tooltip copy-tooltip-w" data-action="clipboard#copy" data-clipboard-target="tooltip" data-clipboard-tooltip-value="{% trans %}Copy to clipboard{% endtrans %}">
              {% trans %}Copy{% endtrans %}
            </button>
          </td>
        </tr>
        <tr data-controller="clipboard">
          <th scope="row">MD5</th>
          <td><code data-clipboard-target="source">{{ file.md5_digest }}</code></td>
          <td class="table__align-right">
            <button type="button" class="button button--small copy-tooltip copy-tooltip-w" data-action="clipboard#copy" data-clipboard-target="tooltip" data-clipboard-tooltip-value="{% trans %}Copy to clipboard{% endtrans %}">
              {% trans %}Copy{% endtrans %}
            </button>
          </td>
        </tr>
        <tr data-controller="clipboard">
          <th scope="row">BLAKE2b-256</th>
          <td><code data-clipboard-target="source">{{ file.blake2_256_digest }}</code></td>
          <td class="table__align-right">
            <button type="button" class="button button--small copy-tooltip copy-tooltip-w" data-action="clipboard#copy" data-clipboard-target="tooltip" data-clipboard-tooltip-value="{% trans %}Copy to clipboard{% endtrans %}">
              {% trans %}Copy{% endtrans %}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      {% trans href='https://pip.pypa.io/en/stable/topics/secure-installs/#hash-checking-mode', title=gettext('External link') %}
        <a href="{{ href }}" title="{{ title }}" target="_blank" rel="noopener">See more details on using hashes here.</a>
      {% endtrans %}
    </p>
  </div>

  {% if file.provenance %}
  <h3>Provenance</h3>
    {% set provenance = file.provenance.as_model %}
    <p>
    The following attestation bundles were made for <code>{{ file.filename }}</code>:
    </p>

    {% for bundle in provenance.attestation_bundles %}
      <div class="file">
        <div class="file__graphic">
          <i class="fa-solid fa-file-circle-check" aria-hidden="true"></i>
        </div>

        <div class="card file__card">
          {{ publisher(bundle.publisher )}}
          Attestations:
          <ul>
            {% for attestation in bundle.attestations %}
            <li>
              {% set statement = attestation.statement %}
              Statement type: <a href="{{ statement._type }}"><code>{{ statement._type }}</code></a>
              <ul>
                <li>Predicate type: <a href="{{ statement.predicateType }}"><code>{{ statement.predicateType }}</code></a></li>
                <li>Subject name: <code>{{ statement.subject[0].name }}</code></li>
                <li>Subject digest: <code>{{ statement.subject[0].digest.sha256 }}</code></li>
                {% set tlog_entry = attestation.verification_material.transparency_entries[0] %}
                <li>Sigstore transparency entry: <a href="https://search.sigstore.dev/?logIndex={{ tlog_entry.logIndex }}">{{ tlog_entry.logIndex }}</a> </li>
                <li>Sigstore integration time: {{ humanize(tlog_entry.integratedTime | int | ctime, time="true") }} </li>
              </ul>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>
