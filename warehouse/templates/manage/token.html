{#
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-#}
{% extends "manage_base.html" %}

{% set user = request.user %}
{% set title = "API token management" %}

{% block account_active %}vertical-tabs__tab--is-active{% endblock %}
{% block account_mobile_active %}vertical-tabs__tab--is-active{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block main %}
  <h1 class="page-title">{{ title }}</h1>

  {% if serialized_macaroon %}
  <section id="provisioned-key">
    <div class="callout-block callout-block--warning">
      <p>
        This token will only appear once. Copy it now.
      </p>
      <!-- TODO: This needs to be word-wrapped -->
      <p>
        {{ serialized_macaroon }}
      </p>
    </div>
  </section>
  {% endif %}

  {% if user.macaroons|length > 0 %}
  <section id="active-tokens">
    <h2>Active API tokens</h2>
    <table class="table table--light">
      <thead>
        <th>Description</th>
        <th>Scope</th>
        <th>Created</th>
        <th colspan="2">Last used</th>
      </thead>
      <tbody>
        {% for macaroon in user.macaroons %}
        <tr>
          <td>{{ macaroon.description }}</td>
          <td>TODO: Scope</td>
          <td>{{ humanize(macaroon.created) }}</td>
          <td>{{ humanize(macaroon.last_used) if macaroon.last_used else "Never" }}</td>
          <td class="table__action">
            <a href="#delete-token" class="button button--primary">Delete</a>
            {% set title="Remove API token - " + macaroon.description %}
            {% set confirm_button_label="Remove API token" %}
            {% set extra_fields %}
              <input type="text" name="macaroon_id" value="{{ macaroon.id }}" hidden>
            {% endset %}
            {{ confirm_modal(title=title, confirm_name="Username", confirm_string=user.username, confirm_button_label=confirm_button_label, slug="delete-token", extra_fields=extra_fields, warning=False, confirm_string_in_title=False) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}

  {{ form_error_anchor(create_macaroon_form) }}
  <section id="add-token">
    <h2>Create a new API token</h2>
    <form method="POST">
      <input type="hidden" name="csrf_token" value="{{ request.session.get_csrf_token() }}">
      {{ form_errors(create_macaroon_form) }}
      <div class="form-group">
        <input type="text" name="description">
        {{ field_errors(create_macaroon_form.description) }}
      </div>
      <div class="form-group">
        Scope:
        <select name="token_scope">
          <option value="scope:user">User (all projects)</option>
        {% for project in project_names %}
          <option value="scope:project:{{ project }}">{{ project }}</option>
        {% endfor %}
        </select>
        {{ field_errors(create_macaroon_form.token_scope) }}
      </div>
      <div>
        <input value="Create token" class="button button--primary" type="submit">
      </div>
    </form>
  </section>
{% endblock %}
