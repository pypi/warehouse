{#
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-#}
{% extends "manage_base.html" %}

{% set user = request.user %}
{% set title = gettext("Add API token") %}

{% set active_tab = 'account' %}

{% block title %}
  {% if create_macaroon_form.errors %}{% trans %}Error processing form{% endtrans %} â€“{% endif %}
  {{ title }}
{% endblock %}

{% block main %}
  <h1 class="page-title">{{ title }} <span class="badge badge--warning">{% trans %}Beta feature{% endtrans %}</span></h1>

  {% if serialized_macaroon %}
  <section id="provisioned-key">
    <h2>{% trans macaroon_description=macaroon.description %}Token for "{{ macaroon_description }}"{% endtrans %}</h2>
    <p>
      <strong>{% trans %}Permissions:{% endtrans %}</strong> {% trans %}Upload packages{% endtrans %}<br>
      {% if macaroon.caveats.permissions == "user" %}
      <strong>{% trans %}Scope:{% endtrans %}</strong> {% trans %}Entire account (all projects){% endtrans %}
      {% else %}
        {% for project in macaroon.caveats.permissions.projects %}
        <strong>{% trans %}Scope:{% endtrans %}</strong> {% trans project=macaroon.caveats.permissions.projects[0] %}Project "{{ project }}"{% endtrans %}
        {% endfor %}
      {% endif %}
    </p>

    <code class="code-block">{{ serialized_macaroon }}</code>
    <div class="margin-bottom--large">
      <div class="callout-block callout-block--danger no-top-margin">
        <p>{% trans %}For security reasons this token will only appear once. <strong>Copy it now.</strong>{% endtrans %}</p>
      </div>
      <button type="button" class="button button--primary copy-tooltip copy-tooltip-e" aria-label="{% trans %}Copy token to clipboard{% endtrans %}" data-tooltip-label="{% trans %}Copy token to clipboard{% endtrans %}" data-clipboard-text="{{ serialized_macaroon }}">
        {% trans %}Copy token{% endtrans %}
      </button>
      <a href="#remove-API-token--{{ macaroon.id }}" class="button">
        {% trans %}Remove token{% endtrans %}
      </a>
      {% set slug="remove-API-token--" + macaroon.id | string %}
      {% set title=gettext("Remove API token") + " - " + macaroon.description %}
      {% set confirm_button_label=gettext("Remove API token") %}
      {% set extra_fields %}
        <input type="hidden" name="macaroon_id" value="{{ macaroon.id }}" autocomplete="off">
      {% endset %}
      {% set token_warning_text %}
        <p>{% trans %}Applications or scripts using this token will no longer have access to PyPI.{% endtrans %}</p>
      {% endset %}

      {{ confirm_password_modal(title=title, slug=slug, confirm_button_label=confirm_button_label, extra_fields=extra_fields, custom_warning_text=token_warning_text) }}
    </div>

    <h2>{% trans %}Using this token{% endtrans %}</h2>

    <p>{% trans %}To use this API token:{% endtrans %}</p>

    <ul>
      <li>{% trans token='__token__' %}Set your username to <code>{{ token }}</code>{% endtrans %}</li>
      <li>{% trans prefix='pypi-' %}Set your password to the token value, including the <code>{{ prefix }}</code> prefix{% endtrans %}</li>
    </ul>

    {% if macaroon.caveats.permissions == "user" %}

    <p>
      {% trans trimmed href='https://pypi.org/project/virtualenv/', filename='$HOME/.pypirc' %}
        For example, if you are using <a href="{{ href }}">Twine</a> to upload your projects to PyPI, set up your <code>{{ filename }}</code> file like this:
      {% endtrans %}
    </p>
    <pre class="code-block">
[pypi]
  username = __token__
  password = {{ serialized_macaroon }}</pre>
    {% else %}
    <p>
      {% trans trimmed href='https://pypi.org/project/virtualenv/', filename='$HOME/.pypirc' %}
        For example, if you are using <a href="{{ href }}">Twine</a> to upload multiple projects to PyPI, you can set up your <code>{{ filename }}</code> file like this:
      {% endtrans %}
    </p>
    <pre class="code-block">
[pypi]
  username = __token__
  password = # {% trans %}either a user-scoped token or a project-scoped token you want to set as the default{% endtrans %}

[PROJECT_NAME]
  username = __token__
  password = # {% trans %}a project token{% endtrans %} </pre>
    <p>
      {% trans trimmed command='twine --repository PROJECT_NAME' %}
        You can then use <code>{{ command }}</code> to switch to the correct token when uploading to PyPI.
      {% endtrans %}
    </p>
    {% endif %}

    <p>{% trans href='/help#apitoken' %}For further instructions on how to use this token, <a href="{{ href }}">visit the PyPI help page</a>.{% endtrans %}</p>
  </section>
  <hr>
  {% endif %}

  {{ form_error_anchor(create_macaroon_form) }}
  <section id="add-token">
    {% if serialized_macaroon %}
    <h2>{% trans %}Add another token{% endtrans %}</h2>
    {% endif %}
    <form method="POST">
      <input type="hidden" name="csrf_token" value="{{ request.session.get_csrf_token() }}">
      {{ form_errors(create_macaroon_form) }}
      <div class="form-group">
        <label for="description" class="form-group__label">
          {% trans %}Token name{% endtrans %}
          {% if create_macaroon_form.description.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        <input type="text" name="description" id="description" autocomplete="off" autocapitalize="off" spellcheck="false" class="form-group__input" aria-describedby="token-name-errors description-help-text" value="{{ create_macaroon_form.description.data or ""}}">
        <div id="token-name-errors">
          {{ field_errors(create_macaroon_form.description) }}
        </div>
        <p id="description-help-text" class="form-group__help-text">{% trans %}What is this token for?{% endtrans %}</p>
      </div>
      <div class="form-group">
        <span class="form-group__label">{% trans %}Permissions{% endtrans %}</span>
        <p class="form-group__text">{% trans %}Upload packages{% endtrans %}</p>
      </div>
      <div class="form-group token-scopes" data-controller="token-scopes">
        <label for="token_scopes" class="form-group__label">
          {% trans %}Scope{% endtrans %}
          {% if create_macaroon_form.token_scopes.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        {% set token_scopes = create_macaroon_form.token_scopes.data %}
        {% set all_projects = not token_scopes or token_scopes == ["scope:user"] %}
        <div>
          <input type="radio" name="token_scopes" value="scope:user" id="scope:user" data-action="token-scopes#user" {{ "checked" if all_projects }}>
          <label for="scope:user">{% trans %}Entire account (all projects){% endtrans %}</label>
        </div>
        <div>
          <input type="radio" name="token_scopes" value="scope:unspecified" id="scope:unspecified" data-action="token-scopes#unspecified" {{ "checked" if not all_projects }}>
          <label for="scope:unspecified">{% trans %}By project{% endtrans %}</label>
        </div>
        {% if project_names|length > 10 %}
        <select multiple name="token_scopes" id="token_scopes" class="form-group__input form-group__multiselect" aria-describedby="token_scopes-errors" autocomplete="off" data-target="token-scopes.selector" {{ "disabled" if all_projects }}>
        {% for project in project_names %}
          {% set project_value = 'scope:project:' + project %}
          <option value="{{ project_value }}" {{ "selected" if project_value in token_scopes }}>{{ project }}</option>
        {% endfor %}
        </select>
        <p class="{{ "disabled" if token_scopes == ["scope:user"] or not token_scopes }}" data-target="token-scopes.description">{% trans %}To select more than one project, hold down Ctrl (Windows/Linux) or Command (Mac).{% endtrans %}</p>
        {% else %}
        {% for project in project_names %}
          {% set project_value = 'scope:project:' + project %}
          <div>
            <input type="checkbox" class="token-scopes__checkbox" value="{{ project_value }}" id="{{ project_value }}" data-target="token-scopes.selector" {{ "checked" if project_value in token_scopes }} {{ "disabled" if all_projects }}>
            <label for="{{ project_value }}" class="{{ "disabled" if all_projects }}" data-target="token-scopes.description">{{ project }}</label>
          </div>
        {% endfor %}
        {% endif %}
        <div id="scope-errors">
          {{ field_errors(create_macaroon_form.token_scopes) }}
        </div>
      </div>
      <div id="api-token-scope-warning" class="callout-block callout-block--warning" hidden>
        <h3 class="callout-block__heading">{% trans %}Proceed with caution!{% endtrans %}</h3>
        <p>{% trans %}An API token scoped to your entire account will have upload permissions for all of your current and future projects.{% endtrans %}</p>
      </div>
      <div>
        <input value="{% trans %}Add token{% endtrans %}" class="button button--primary" type="submit">
      </div>
    </form>
  </section>
{% endblock %}
