{#
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-#}
{% extends "manage_base.html" %}

{% set active_tab = 'organizations' %}

{% block title %}{% trans %}Your organizations{% endtrans %}{% endblock %}

{% block main %}
  {% if organization_invites %}
  <h1 class="page-title">{% trans invitation_count=organization_invites|length %}Pending invitations ({{ invitation_count }}){% endtrans %}</h1>
  <div class="organization-list">
    {% for organization, token in organization_invites %}
    <div class="organization-snippet">
      <div class="split-layout split-layout--no-wrap split-layout--wrap-on-tablet">
        <div>
          <h3 class="organization-snippet__title">
            {{ organization.name }}
          </h3>
          <p class="organization-snippet__meta">
            {% trans creation_date=humanize(organization.created) %}Created {{ creation_date }}{% endtrans %}
          </p>
        </div>
        <div class="organization-snippet__buttons">
          <form method="POST" action="{{ request.route_path('accounts.verify-organization-role') }}">
            <input name="csrf_token" type="hidden" value="{{ request.session.get_csrf_token() }}">
            <input name="token" type="hidden" value="{{ token }}">
            <input name="accept" type="submit" value="{% trans %}Accept{% endtrans %}" class="button button--primary">
            <input name="decline" type="submit" value="{% trans %}Decline{% endtrans %}" class="button">
          </form>
        </div>
      </div>
    </div>
    {% endfor%}
  </div>
  {% endif %}

  <h1 class="page-title">{% trans organization_count=organizations|length %}Your organizations ({{ organization_count }}){% endtrans %}</h1>
  <div class="organization-list">
    {% for organization in organizations if organization.is_approved != False %}
    <div class="organization-snippet">
      <div class="split-layout split-layout--no-wrap split-layout--wrap-on-tablet">
        <div>
          <h3 class="organization-snippet__title">{{ organization.name }}
            {% if organization.orgtype == OrganizationType.Company and not organization.active_subscription %}
              {% if organization.name in (organizations_owned + organizations_billing) %}
              <a class="badge badge--danger organization-snippet__badge" href="{{ request.route_path('manage.organization.activate_subscription', organization_name=organization.normalized_name) }}">{% trans %}Billing Inactive{% endtrans %}</a>
              {% else %}
              <span class="badge badge--danger organization-snippet__badge" title="{% trans %}This organization's billing can be activated by an organization owner or billing manager{% endtrans %}">{% trans %}Billing Inactive{% endtrans %}</span>
              {% endif %}
            {% elif organization.is_approved == None %}
            <span class="badge badge--neutral organization-snippet__badge" title="{% trans %}You will receive an email when the organization has been approved{% endtrans %}">{% trans %}Request Submitted{% endtrans %}</span>
            {% elif organization.is_active == False %}
            <span class="badge badge--danger organization-snippet__badge" title="{% trans %}This organization is not active{% endtrans %}">{% trans %}Inactive{% endtrans %}</span>
            {% elif organization.name in organizations_managed %}
            <a class="badge badge--warning organization-snippet__badge" href="{{ request.route_path('manage.organization.roles', organization_name=organization.normalized_name) }}">{% trans %}Manager{% endtrans %}</a>
            {% elif organization.name in organizations_owned %}
            <a class="badge badge--warning organization-snippet__badge" href="{{ request.route_path('manage.organization.roles', organization_name=organization.normalized_name) }}">{% trans %}Owner{% endtrans %}</a>
            {% elif organization.name in organizations_billing %}
            <a class="badge badge--success organization-snippet__badge" href="{{ request.route_path('manage.organization.settings', organization_name=organization.normalized_name) }}">{% trans %}Billing Manager{% endtrans %}</a>
            {% endif %}
          </h3>
          <p class="organization-snippet__meta">
            {% trans creation_date=humanize(organization.created) %}Created {{ creation_date }}{% endtrans %}
          </p>
        </div>
        <div class="organization-snippet__buttons">
          {% if organization.name not in (organizations_managed + organizations_owned + organizations_billing) %}
          {# Show "View" button for non-manager and non-owner #}
          <a class="button" href="{{ request.route_path('manage.organization.roles', organization_name=organization.normalized_name) }}" title="{% trans %}View this organization{% endtrans %}">
            {% trans %}View{% endtrans %}
          </a>
          {% elif organization.orgtype == OrganizationType.Company and not organization.active_subscription %}
            {% if organization.name in (organizations_owned + organizations_billing) %}
            {# Show "Activate Billing" button for owners and billing managers #}
            <a class="button button--primary" href="{{ request.route_path('manage.organization.activate_subscription', organization_name=organization.normalized_name) }}" title="{% trans %}Activate billing for this organization{% endtrans %}">
              {% trans %}Activate Billing{% endtrans %}
            </a>
            {% else %}
            {# Show disabled "Manage" button for managers #}
            <button class="button button--primary" disabled title="{% trans %}This organization is not active{% endtrans %}">
              {% trans %}Manage{% endtrans %}
            </button>
            {% endif %}
          {% elif not organization.is_active %}
          {# Show disabled "Manage" button for inactive organization #}
          <button class="button button--primary" disabled title="{% trans %}This organization is not active{% endtrans %}">
            {% trans %}Manage{% endtrans %}
          </button>
          {% elif organization.name in organizations_billing %}
          {# Show "Manage" button for billing managers #}
          <a class="button button--primary" href="{{ request.route_path('manage.organization.settings', organization_name=organization.normalized_name) }}" title="{% trans %}Manage this organization{% endtrans %}">
            {% trans %}Manage{% endtrans %}
          </a>
          {% else %}
          {# Show "Manage" button for managers and owners #}
          <a class="button button--primary" href="{{ request.route_path('manage.organization.roles', organization_name=organization.normalized_name) }}" title="{% trans %}Manage this organization{% endtrans %}">
            {% trans %}Manage{% endtrans %}
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% else %}
      <div class="callout-block no-top-margin">
        <p>{% trans %}You have not joined any organizations on PyPI, yet.{% endtrans %}</p>
      </div>
    {% endfor %}
  </div>

  <hr>

  {{ form_error_anchor(create_organization_form) }}
  <section id="create-organization">
    <h2 class="sub-title">{% trans %}Create new organization{% endtrans %}</h2>
    {% set pending_organization_request = organizations|selectattr("is_approved", "none")|first %}
    {% if pending_organization_request %}
    <p>
      {% trans organization_name=pending_organization_request.name %}Your request for a new PyPI organization named '{{ organization_name }}' has been submitted.{% endtrans %}
    </p>
    <p>
      {% trans %}You will receive an email when the organization has been approved{% endtrans %}{% trans %}.{% endtrans %}
    </p>
    {% else %}
    <form method="POST">
      <input name="csrf_token" type="hidden" value="{{ request.session.get_csrf_token() }}">
      {{ form_errors(create_organization_form) }}
      <div class="form-group">
        <label for="name" class="form-group__label">
          {% trans %}Organization account name{% endtrans %}
          {% if create_organization_form.name.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        {{ create_organization_form.name(placeholder=gettext("Select an organization account name"), autocapitalize="off", autocomplete="off", spellcheck="false", required="required", class_="form-group__field", **{"aria-describedby":"name-errors"}) }}
        <div id="name-errors">
          {% if create_organization_form.name.errors %}
          <ul class="form-errors" role="alert">
            {% for error in create_organization_form.name.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        <p class="form-group__help-text">
          {% trans %}This account name will be used in URLs on PyPI.{% endtrans %}<br>
          {% trans %}For example{% endtrans %}: psf
        </p>
      </div>

      <div class="form-group">
        <label for="display_name" class="form-group__label">
          {% trans %}Organization name{% endtrans %}
          {% if create_organization_form.display_name.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        {{ create_organization_form.display_name(placeholder=gettext("Name of your business, product, or project"), autocomplete="organization", autocapitalize="off", spellcheck="false", class_="form-group__field", **{"aria-describedby":"display-name-errors"}) }}
        <div id="display-name-errors">
          {% if create_organization_form.display_name.errors %}
          <ul class="form-errors" role="alert">
            {% for error in create_organization_form.display_name.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        <p class="form-group__help-text">
          {% trans %}For example{% endtrans %}: Python Software Foundation
        </p>
      </div>

      <div class="form-group">
        <label class="form-group__label" for="link_url">
          {% trans %}️Organization URL{% endtrans %}
          {% if create_organization_form.link_url.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        <p class="form-group__text">
          {{ create_organization_form.link_url(placeholder=gettext("URL for your business, product, or project"), autocomplete="url", autocapitalize="off", spellcheck="false", class_="form-group__field", **{"aria-describedby":"link-url-errors"}) }}
        </p>
        <div id="link-url-errors">
          {{ field_errors(create_organization_form.link_url) }}
        </div>
        <p class="form-group__help-text">
          {% trans %}For example{% endtrans %}: https://www.python.org/psf/
        </p>
      </div>

      <div class="form-group">
        <label for="description" class="form-group__label">
          {% trans %}Organization description{% endtrans %}
          {% if create_organization_form.description.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        {{ create_organization_form.description(placeholder=gettext("Description of your business, product, or project"), autocomplete="off", autocapitalize="off", spellcheck="true", class_="form-group__field", **{"aria-describedby":"description-errors"}) }}
        <div id="description-errors">
          {% if create_organization_form.description.errors %}
          <ul class="form-errors" role="alert">
            {% for error in create_organization_form.description.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label class="form-group__label" for="orgtype">
          {% trans %}️Organization type{% endtrans %}
          {% if create_organization_form.orgtype.flags.required %}
          <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
          {% endif %}
        </label>
        <p class="form-group__text">
          {{ create_organization_form.orgtype(class_="form-group__field", **{"aria-describedby":"orgtype-errors"}) }}
        </p>
        <div id="orgtype-errors">
          {{ field_errors(create_organization_form.orgtype) }}
        </div>
        <p class="form-group__help-text">
          {% trans trimmed %}
            Companies can create organization accounts as a paid service while community projects are granted complimentary access.
          {% endtrans %}
        </p>
      </div>

      <input value="{% trans %}Create{% endtrans %}" class="button button--primary" type="submit">
    </form>
    {% endif %}
  </section>
{% endblock %}
