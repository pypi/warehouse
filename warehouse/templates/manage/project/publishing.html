{#
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-#}

{% extends "manage_project_base.html" %}

{% set active_tab = 'publishing' %}

{% block title %}
  {{ oidc_title() }}
{% endblock %}

{% block main %}
{% if testPyPI %}
{% set title = "TestPyPI" %}
{% else %}
{% set title = "PyPI" %}
{% endif %}

<div class="horizontal-section">
  <div class="site-container">
    <h1 class="page-title">{{ oidc_title() }}</h1>

    {{ oidc_desc() }}

    <h2>{% trans %}Manage current publishers{% endtrans %}</h2>
    {% if project.oidc_publishers %}
    <table class="table table--publisher-list">
      <caption class="sr-only">
        {% trans project_name=project.name %}OpenID Connect publishers associated with {{ project_name }}{% endtrans %}
      </caption>
      <thead>
        <tr>
          <th scope="col">{% trans %}Publisher{% endtrans %}</th>
          <th scope="col">{% trans %}Repository{% endtrans %}</th>
          <th scope="col">{% trans %}Workflow{% endtrans %}</th>
          <th scope="col">{% trans %}Environment name{% endtrans %}</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for publisher in project.oidc_publishers %}
        {{ oidc_publisher_row(publisher) }}
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="no-bottom-padding">{% trans %}No publishers are currently configured.{% endtrans %}</p>
    {% endif %}

    <h2 class="no-bottom-padding">{% trans %}Add a new publisher{% endtrans %}</h2>
    {% if request.user.has_two_factor %}
    <div class="horizontal-tabs" data-controller="horizontal-tabs" data-horizontal-tabs-index="{{ ("github", "buildkite").index(default_publisher_name) }}">
      <div class="horizontal-tabs__tabbar">
        <button data-horizontal-tabs-target="tab" data-action="horizontal-tabs#change" class="tab">
          GitHub
        </button>

        <button data-horizontal-tabs-target="tab" data-action="horizontal-tabs#change" class="tab">
          Buildkite
        </button>
      </div>

      <div class="horizontal-tabs__tabcontent" data-horizontal-tabs-target="tabPanel">
        <p>
          {% trans href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect" %}
          Read more about GitHub Actions's OpenID Connect support <a href="{{ href }}">here</a>.
          {% endtrans %}
        </p>

        {{ form_error_anchor(github_publisher_form) }}
        <form method="POST" action="{{ request.route_path('manage.project.settings.publishing', project_name=project.name) }}#errors">
          <input name="csrf_token" type="hidden" value="{{ request.session.get_csrf_token() }}">
          {{ form_errors(github_publisher_form) }}
          <div class="form-group">
            <label for="owner" class="form-group__label">
              {% trans %}Owner{% endtrans %}
              {% if github_publisher_form.owner.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% endif %}
            </label>
            {{ github_publisher_form.owner(placeholder=gettext("owner"), autocomplete="off", autocapitalize="off", spellcheck="false", class_="form-group__field", aria_describedby="owner-errors") }}
            <p class="form-group__help-text">
              {% trans %}The GitHub organization name or GitHub username that owns the repository{% endtrans %}
            </p>
            <div id="owner-errors">
              {{ field_errors(github_publisher_form.owner) }}
            </div>
          </div>
          <div class="form-group">
            <label for="repository" class="form-group__label">
              {% trans %}Repository name{% endtrans %}
              {% if github_publisher_form.repository.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% endif %}
            </label>
            {{ github_publisher_form.repository(placeholder=gettext("repository"), autocomplete="off", autocapitalize="off", spellcheck="false", class_="form-group__field", **{"aria-describedby":"repository-errors"}) }}
            <p class="form-group__help-text">
              {% trans %}The name of the GitHub repository that contains the publishing workflow{% endtrans %}
            </p>
            <div id="repository-errors">
              {{ field_errors(github_publisher_form.repository) }}
            </div>
          </div>
          <div class="form-group">
            <label for="workflow_filename" class="form-group__label">
              {% trans %}Workflow name{% endtrans %}
              {% if github_publisher_form.workflow_filename.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% endif %}
            </label>
            {{ github_publisher_form.workflow_filename(placeholder=gettext("workflow.yml"), class_="form-group__field", autocomplete="off", **{"aria-describedby":"workflow_filename-errors"}) }}
            <p class="form-group__help-text">
              {% trans %}The filename of the publishing workflow. This file should exist in the <code>.github/workflows/</code> directory in the repository configured above.{% endtrans %}
            </p>
            <div id="workflow_filename-errors">
              {{ field_errors(github_publisher_form.workflow_filename) }}
            </div>
          </div>
          <div class="form-group">
            <label for="environment" class="form-group__label">
              {% trans %}Environment name{% endtrans %}
              {% if github_publisher_form.environment.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ github_publisher_form.environment(placeholder=gettext("release"), class_="form-group__field", autocomplete="off", **{"aria-describedby":"environment-errors"}) }}
            <p class="form-group__help-text">
              {% trans href="https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment" %}
              The name of the <a href="{{ href }}">GitHub Actions environment</a>
              that the above workflow uses for publishing.  This should be
              configured under the repository's settings. While not required, a
              dedicated publishing environment is <strong>strongly</strong>
              encouraged, <strong>especially</strong> if your repository has
              maintainers with commit access who shouldn't have PyPI publishing
              access.
              {% endtrans %}
            </p>
            <div id="environment-errors">
              {{ field_errors(github_publisher_form.environment) }}
            </div>
          </div>
          <div>
            <input type="submit" value="{% trans %}Add{% endtrans %}" class="button button--primary">
          </div>
        </form>
      </div>

      <div class="horizontal-tabs__tabcontent" data-horizontal-tabs-target="tabPanel">
        <p>
          {% trans href="https://buildkite.com/docs/agent/v3/cli-oidc#request-oidc-token" %}
            Read more about Buildkite's OpenID Connect support <a href="{{ href }}">here</a>.
          {% endtrans %}
        </p>

        <form method="POST" action="{{ request.route_path('manage.project.settings.publishing.buildkite', project_name=project.name) }}#errors">
          <input name="csrf_token" type="hidden" value="{{ request.session.get_csrf_token() }}">
          {{ form_errors(buildkite_publisher_form) }}
          <div class="form-group">
            <label for="organization_slug" class="form-group__label">
              {% trans %}Organization{% endtrans %}
              {% if buildkite_publisher_form.organization_slug.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ buildkite_publisher_form.organization_slug(placeholder=gettext("acme-inc"), autocomplete="off", autocapitalize="off", spellcheck="false", class_="form-group__field", aria_describedby="organization_slug-errors") }}
            <p class="form-group__help-text">
              {% trans %}The slug of the Buildkite organization that owns the pipeline{% endtrans %}
            </p>
            <div id="organization_slug-errors">
              {{ field_errors(buildkite_publisher_form.organization_slug) }}
            </div>
          </div>
          <div class="form-group">
            <label for="pipeline_slug" class="form-group__label">
              {% trans %}Pipeline{% endtrans %}
              {% if buildkite_publisher_form.pipeline_slug.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ buildkite_publisher_form.pipeline_slug(placeholder=gettext("widgets-client"), autocomplete="off", autocapitalize="off", spellcheck="false", class_="form-group__field", aria_describedby="pipeline_slug-errors") }}
            <p class="form-group__help-text">
              {% trans %}The slug of the Buildkite pipeline that contains the publishing steps{% endtrans %}
            </p>
            <div id="pipeline_slug-errors">
              {{ field_errors(buildkite_publisher_form.pipeline_slug) }}
            </div>
          </div>
          <div class="form-group">
            <label for="build_branch" class="form-group__label">
              {% trans %}Branch name{% endtrans %}
              {% if buildkite_publisher_form.build_branch.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ buildkite_publisher_form.build_branch(placeholder=gettext("main"), class_="form-group__field", autocomplete="off", aria_describedby="build_branch-errors") }}
            <p class="form-group__help-text">
              {% trans %}Restrict publishing to a specific branch by supplying a branch name{% endtrans %}
            </p>
            <div id="build_branch-errors">
              {{ field_errors(buildkite_publisher_form.build_branch) }}
            </div>
          </div>
          <div class="form-group">
            <label for="build_tag" class="form-group__label">
              {% trans %}Tag name{% endtrans %}
              {% if buildkite_publisher_form.build_tag.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ buildkite_publisher_form.build_tag(placeholder=gettext("main"), class_="form-group__field", autocomplete="off", aria_describedby="build_tag-errors") }}
            <p class="form-group__help-text">
              {% trans %}Restrict publishing to a specific tag by supplying a tag name{% endtrans %}
            </p>
            <div id="build_tag-errors">
              {{ field_errors(buildkite_publisher_form.build_tag) }}
            </div>
          </div>
          <div class="form-group">
            <label for="step_key" class="form-group__label">
              {% trans %}Step key{% endtrans %}
              {% if buildkite_publisher_form.step_key.flags.required %}
              <span class="form-group__required">{% trans %}(required){% endtrans %}</span>
              {% else %}
              <span class="form-group__required">{% trans %}(optional){% endtrans %}</span>
              {% endif %}
            </label>
            {{ buildkite_publisher_form.step_key(placeholder=gettext("publish-python-package"), class_="form-group__field", autocomplete="off", aria_describedby="step_key-errors") }}
            <p class="form-group__help-text">
              {% trans href="https://buildkite.com/docs/pipelines/command-step#agents" %}
              Restrict publishing to a specific step in your pipeline by supplying a <a href="{{ href }}">step key</a>
              {% endtrans %}
            </p>
            <div id="build_branch-errors">
              {{ field_errors(buildkite_publisher_form.build_branch) }}
            </div>
          </div>
          <div>
            <input type="submit" value="{% trans %}Add{% endtrans %}" class="button button--primary">
          </div>
        </form>
      </div>
    </div>

    {% else %}{# user has not enabled 2FA #}
    <div class="callout-block callout-block--warning">
      {% trans href=request.route_path('manage.account.two-factor') %}
      You must first enable <a href="{{ href }}">two-factor authentication</a> on your account before adding a new publisher.
      {% endtrans %}
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}

