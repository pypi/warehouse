language: python
python: 3.8.2

env:
  global:
    - TRAVIS_NODE_VERSION=14.4.0
    - PGPORT=5433

dist: bionic

addons:
  hosts:
    - warehouse.local
  postgresql: 12
  apt:
    packages:
    - postgresql-12
    - postgresql-client-12
    - nasm
    - libgnutls28-dev

services:
  - postgresql

cache:
  directories:
    - ~/.cache/pip
    - ~/.nvm/versions/
    - ~/.npm

install:
  - nvm install $TRAVIS_NODE_VERSION
  - pip install -U pip setuptools wheel
  - pip install -r requirements.txt
  - pip install -r requirements/dev.txt
  - npm i -g npm
  - npm install -g gulp-cli
  - npm ci

script:
  - node -v
  - npm -v
  - bin/tests --postgresql-host 127.0.0.1

matrix:
  include:
    - env:
      - SUITE=Tests
    - script: bin/lint
      env:
        - SUITE=Lint
    - script: make docs BINDIR="$(dirname $(which python))"
      env:
        - SUITE=Documentation
    - script: make travis-deps BINDIR="$(dirname $(which python))"
      env:
        - SUITE=Dependencies
    - script: make licenses BINDIR="$(dirname $(which python))"
      env:
        - SUITE=Licenses
    - script: make translations BINDIR="$(dirname $(which python))"
      env:
        - SUITE=Translations
    - script: bin/static_tests
      env:
        - SUITE="Static Tests"
    - script: bin/static_lint
      env:
        - SUITE="Static Lint"
    - script: bin/static_pipeline
      env:
        - SUITE="Static Pipeline"
